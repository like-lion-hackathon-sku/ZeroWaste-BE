// ìœ„ì¹˜: src/restaurants/controller/nearby.controller.js
import { StatusCodes } from "http-status-codes";
import { searchLocal } from "../service/naver.service.js";
import { ensureRestaurant } from "../service/restaurants.service.js";
import { getRestaurantScore } from "../service/score.service.js";

// ë„“ì€ ë²”ìœ„ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (ìŒì‹ì /ì¹´í˜/ì£¼ì  ê³„ì—´ ì „ë¶€)
const KR = [
  "ìŒì‹ì ",
  "ì‹ë‹¹",
  "ë¶„ì‹",
  "ë°±ë°˜",
  "êµ­ë°¥",
  "ì°Œê°œ",
  "ì „ê³¨",
  "í•´ì¥êµ­",
  "ê°ìíƒ•",
  "ì¹¼êµ­ìˆ˜",
  "ëƒ‰ë©´",
  "êµ­ìˆ˜",
  "ë³´ìŒˆ",
  "ì¡±ë°œ",
  "ìˆœëŒ€",
  "ê³±ì°½",
  "ë§‰ì°½",
  "ëŒ€ì°½",
  "ë‹­ê°ˆë¹„",
  "ë‹­ë°œ",
  "ë‹­ê¼¬ì¹˜",
  "ë‹­í•œë§ˆë¦¬",
  "ì‚¼ê³„íƒ•",
  "ì‚¼ê²¹ì‚´",
  "ê³ ê¸°êµ¬ì´",
  "ë¼ì§€ê°ˆë¹„",
  "ê°ˆë¹„",
  "ë¶ˆê³ ê¸°",
  "ì œìœ¡",
  "í•œì •ì‹",
  "ì „",
  "íŒŒì „",
  "ë¹ˆëŒ€ë–¡",
  "í•´ë¬¼íŒŒì „",
  "ìŒˆë°¥",
  "ì£½",
  "ë„ì‹œë½",
  "ìˆ˜ì œë¹„",
  "ê¹€ë°¥",
  "ë–¡ë³¶ì´",
  "íŠ€ê¹€",
  "ë¼ë©´",
  "ë¶„ì‹ì§‘",
  "í•´ë¬¼íƒ•",
  "ì•„ê·€ì°œ",
  "ì°œë‹­",
  "ê³°íƒ•",
  "ì„¤ë íƒ•",
  "ê³°ì¹˜êµ­",
  "ìƒ¤ë¸Œìƒ¤ë¸Œ",
  "ë¹„ë¹”ë°¥",
  "ì­ˆê¾¸ë¯¸",
  "ë‚™ì§€",
  "ê¼¼ì¥ì–´",
  "ì¥ì–´",
  "ê³±ë„ë¦¬íƒ•",
];

const JP = [
  "ì¼ì‹",
  "ì¼ë³¸ì‹",
  "ìŠ¤ì‹œ",
  "ì´ˆë°¥",
  "ì‚¬ì‹œë¯¸",
  "ë¼ë©˜",
  "ë¼ë©´",
  "ìš°ë™",
  "ì†Œë°”",
  "ê·œì¹´ì¸ ",
  "ëˆì¹´ì¸ ",
  "ëˆê¹ŒìŠ¤",
  "ë®ë°¥",
  "ëˆë¶€ë¦¬",
  "ì˜¤ê¼¬ë…¸ë¯¸ì•¼ë¼",
  "íƒ€ì½”ì•¼ë¼",
  "ì´ìì¹´ì•¼",
  "ì˜¤ë§ˆì¹´ì„¸",
  "í…ë™",
  "í…í‘¸ë¼",
  "ê·œë™",
];

const CN = [
  "ì¤‘ì‹",
  "ì¤‘í™”ìš”ë¦¬",
  "ì§œì¥ë©´",
  "ìì¥ë©´",
  "ì§¬ë½•",
  "ìš°ë™(ì¤‘ì‹)",
  "ë³¶ìŒë°¥",
  "íƒ•ìˆ˜ìœ¡",
  "ê¹í’ê¸°",
  "ì–‘ê¼¬ì¹˜",
  "ë§ˆë¼íƒ•",
  "ë§ˆë¼ìƒ¹ê¶ˆ",
  "í› ê¶ˆ",
  "í› ê¶ˆì§‘",
  "ì¤‘êµ­ëƒ‰ë©´",
  "ë”¤ì„¬",
  "í™ì½©ìš”ë¦¬",
  "ì‚¬ì²œìš”ë¦¬",
];

const WEST = [
  "ì–‘ì‹",
  "ì„œì–‘ì‹",
  "ìŠ¤í…Œì´í¬",
  "íŒŒìŠ¤íƒ€",
  "ë¦¬ì¡°ë˜",
  "ê·¸ë¦´",
  "ë°”ë² í",
  "BBQ",
  "ë¸ŒëŸ°ì¹˜",
  "ìƒëŸ¬ë“œ",
  "ìˆ˜ì œë²„ê±°",
  "ë²„ê±°",
  "í”¼ì",
  "ê·¸ë¦¬ìŠ¤",
  "í„°í‚¤",
  "ì¼€ë°¥",
  "í”„ë Œì¹˜",
  "ì´íƒˆë¦¬ì•„",
  "ì´íƒˆë¦¬ì•ˆ",
];

const SEAFOOD = [
  "í•´ì‚°ë¬¼",
  "ìˆ˜ì‚°ë¬¼",
  "íšŸì§‘",
  "íšŒ",
  "ì´ˆë°¥",
  "ë¬¼íšŒ",
  "ì¡°ê°œêµ¬ì´",
  "ëŒ€ê²Œ",
  "í‚¹í¬ë©",
  "ëìŠ¤í„°",
  "ë§¤ìš´íƒ•",
  "ìƒì„ êµ¬ì´",
];

const ASIAN = [
  "ì•„ì‹œì•„ìŒì‹",
  "ë™ë‚¨ì•„",
  "ë² íŠ¸ë‚¨",
  "ìŒ€êµ­ìˆ˜",
  "ë¶„ì§œ",
  "ë°˜ë¯¸",
  "íƒœêµ­",
  "íŒŸíƒ€ì´",
  "ë˜ ì–Œ",
  "ì¸ë„",
  "ì»¤ë¦¬",
  "íƒ„ë‘ë¦¬",
  "ë‚œ",
  "ë„¤íŒ”",
  "íŒŒí‚¤ìŠ¤íƒ„",
  "ë§ë ˆì´ì‹œì•„",
  "ì‹±ê°€í¬ë¥´",
  "ì¸ë„ë„¤ì‹œì•„",
];

const MIDEAST_LATAM = [
  "ì¤‘ë™",
  "ë ˆë°”ë…¼",
  "ì´ìŠ¤ë¼ì—˜",
  "í˜ë¥´ì‹œì•ˆ",
  "ë©•ì‹œì½”",
  "íƒ€ì½”",
  "ë¶€ë¦¬ë˜",
  "í€˜ì‚¬ë””ì•¼",
  "ë‚˜ì´ˆ",
  "ë¸Œë¼ì§ˆ",
  "ìŠˆí•˜ìŠ¤ì½”",
  "ìŠ¤í˜ì¸",
  "íƒ€íŒŒìŠ¤",
];

const CAFE_DESSERT = [
  "ì¹´í˜",
  "ì»¤í”¼",
  "ì»¤í”¼ì „ë¬¸ì ",
  "ë””ì €íŠ¸",
  "ë² ì´ì»¤ë¦¬",
  "ë¹µ",
  "ì œê³¼",
  "ì œë¹µ",
  "ë„ë„›",
  "ë„ë„ˆì¸ ",
  "ì•„ì´ìŠ¤í¬ë¦¼",
  "ë¹™ìˆ˜",
  "ì¼€ì´í¬",
  "íƒ€ë¥´íŠ¸",
  "ë§ˆì¹´ë¡±",
  "ì™€í”Œ",
  "í¬ë¡œì™€ìƒ",
  "í‹°ë£¸",
  "ì´ˆì½œë¦¿",
  "ì‡¼ì½œë¼í‹°ì—",
  "ë¸ŒëŸ°ì¹˜ì¹´í˜",
];

const PUB_BAR = [
  "ìˆ ì§‘",
  "ì£¼ì ",
  "í¬ì°¨",
  "í¬ì¥ë§ˆì°¨",
  "í˜¸í”„",
  "í",
  "ë°”",
  "ì™€ì¸ë°”",
  "ì¹µí…Œì¼ë°”",
  "ì‚¬ì¼€ë°”",
  "ìœ„ìŠ¤í‚¤ë°”",
  "ìˆ˜ì œë§¥ì£¼",
  "ë§¥ì£¼ì§‘",
  "íí•˜ìš°ìŠ¤",
  "ë¸Œë£¨ì–´ë¦¬",
  "ì–‘ì¡°ì¥",
  "ì „í†µì£¼",
  "ë§‰ê±¸ë¦¬ì§‘",
  "ì´ìì¹´ì•¼",
];

const MISC = [
  "ë·”í˜",
  "íŒ¨ìŠ¤íŠ¸í‘¸ë“œ",
  "ìƒŒë“œìœ„ì¹˜",
  "ìƒ¤ë¸Œìƒ¤ë¸Œ",
  "ë·”í",
  "í‘¸ë“œíŠ¸ëŸ­",
  "í‚¤ì¹œ",
  "ë‹¤ì´ë„ˆ",
];

// ìµœì¢… í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (ì¤‘ë³µ ì œê±°)
export const RESTAURANT_CATS = [
  ...new Set([
    ...KR,
    ...JP,
    ...CN,
    ...WEST,
    ...SEAFOOD,
    ...ASIAN,
    ...MIDEAST_LATAM,
    ...CAFE_DESSERT,
    ...PUB_BAR,
    ...MISC,
  ]),
];

// ë¸”ë ‰ ë¦¬ìŠ¤íŠ¸: ìŒì‹ì  ì•„ë‹Œ ì¥ì†Œë“¤
const RESTAURANT_BLACK = [
  "ë³‘ì›",
  "ì˜ì›",
  "ì•½êµ­",
  "í•œì˜ì›",
  "ì¹˜ê³¼",
  "ë‚´ê³¼",
  "í”¼ë¶€ê³¼",
  "ì•ˆê³¼",
  "ì •í˜•ì™¸ê³¼",
  "ì‚°ë¶€ì¸ê³¼",
  "í•™ì›",
  "ë…ì„œì‹¤",
  "ì„œì ",
  "ë¬¸êµ¬",
  "í¸ì˜ì ",
  "ë§ˆíŠ¸",
  "ìŠˆí¼",
  "ë°±í™”ì ",
  "ì•„ìš¸ë ›",
  "ì€í–‰",
  "ATM",
  "ë³´í—˜",
  "ë¶€ë™ì‚°",
  "í—¬ìŠ¤ì¥",
  "í”¼íŠ¸ë‹ˆìŠ¤",
  "ìš”ê°€",
  "í•„ë¼í…ŒìŠ¤",
  "ë¯¸ìš©ì‹¤",
  "í—¤ì–´",
  "ë„¤ì¼",
  "ì™ì‹±",
  "ìŠ¤íŒŒ",
  "í”¼ë¶€ê´€ë¦¬",
  "ë§ˆì‚¬ì§€",
  "í˜¸í…”",
  "ëª¨í…”",
  "ìˆ™ë°•",
  "ê²ŒìŠ¤íŠ¸í•˜ìš°ìŠ¤",
  "íœì…˜",
  "ë¦¬ì¡°íŠ¸",
  "ì¹´ì„¼í„°",
  "ì •ë¹„",
  "ì£¼ìœ ì†Œ",
  "ì„¸ì°¨ì¥",
  "ì„¸íƒì†Œ",
  "ë™ë¬¼ë³‘ì›",
  "ì• ê²¬",
  "ì• ë¬˜",
  "ë°˜ë ¤ë™ë¬¼",
  "ê´€ê³µì„œ",
  "ìš°ì²´êµ­",
  "íŒŒì¶œì†Œ",
  "ê²½ì°°ì„œ",
  "ì†Œë°©ì„œ",
  "í•™êµ",
  "ìœ ì¹˜ì›",
  "ì´ˆë“±í•™êµ",
  "ì¤‘í•™êµ",
  "ê³ ë“±í•™êµ",
  "ëŒ€í•™êµ",
];

// ìœ í‹¸
const norm = (s = "") => String(s).replace(/\s+/g, " ").trim().toLowerCase();
const hasAny = (s, arr) => {
  const n = norm(s);
  return arr.some((t) => n.includes(norm(t)));
};

// ìµœì¢… íŒë³„ í•¨ìˆ˜
export function isRestaurantCategory(cat = "", name = "") {
  // 1) ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìš°ì„  ì°¨ë‹¨
  if (hasAny(cat, RESTAURANT_BLACK) || hasAny(name, RESTAURANT_BLACK))
    return false;
  // 2) í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸(ì¹´í…Œê³ ë¦¬/ì´ë¦„ ë‘˜ ë‹¤ ì²´í¬)
  if (hasAny(cat, RESTAURANT_CATS) || hasAny(name, RESTAURANT_CATS))
    return true;
  // 3) ë„¤ì´ë²„ ê¸°ë³¸ ìƒìœ„ í† í° ì•ˆì „ë§
  return (
    norm(cat).includes("ìŒì‹ì ") ||
    norm(cat).includes("ì¹´í˜") ||
    norm(cat).includes("ì£¼ì ")
  );
}

export const getNearbyRestaurantsCtrl = async (req, res, next) => {
  try {
    const { q } = req.query;
    if (!q) {
      return res.status(StatusCodes.BAD_REQUEST).json({
        resultType: "FAIL",
        error: { code: "QUERY_REQUIRED" },
        success: null,
      });
    }

    // 1) ë„¤ì´ë²„ ê²€ìƒ‰ (ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ throw â†’ next(e) â†’ 500)
    const places = await searchLocal(q, 10);

    // 2) ì‹ë‹¹/ì¹´í˜ ë“±ë§Œ í•„í„°ë§
    const filtered = places.filter((p) =>
      isRestaurantCategory(p?.category, p?.name),
    );

    // 3) ì´ë¦„+ì£¼ì†Œ ê¸°ì¤€ ì¤‘ë³µ ì œê±°
    const uniq = [];
    const seen = new Set();
    for (const p of filtered) {
      const key = `${p.name}__${p.address}`;
      if (seen.has(key)) continue;
      seen.add(key);
      uniq.push(p);
    }

    // 4) DB ë©±ë“± í™•ë³´ + ì ìˆ˜ ì¡°ì¸
    const items = [];
    for (const p of uniq) {
      const { restaurantId } = await ensureRestaurant({ place: p });
      const score = await getRestaurantScore(restaurantId);
      items.push({ restaurantId, ...p, score });
    }

    return res.status(StatusCodes.OK).json({
      resultType: "SUCCESS",
      error: null,
      success: { items },
    });
  } catch (e) {
    next(e); // ğŸ‘‰ ì—ëŸ¬ ê·¸ëŒ€ë¡œ ì „ë‹¬ â†’ í”„ë¡ íŠ¸ì—ì„œ ëª©ì—… ì²˜ë¦¬
  }
};
